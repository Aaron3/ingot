var ingotApp=angular.module("ingotApp",["ui.router","ui.bootstrap","colorpicker.module","pascalprecht.translate","ngAria","ngResource"]).run(function($rootScope,$state){$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){"clickTests"==toState.name?$rootScope.main_click_tests_page=!0:$rootScope.main_click_tests_page=!1}),$rootScope.isActiveNav=function(page){return $state.current.name&&$state.current.name.indexOf(page)>=0?"active":void 0}});ingotApp.config(function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("clickTests",{url:"/click-tests",templateUrl:INGOT_ADMIN.partials+"/click-groups.html"}).state("clickTests.list",{url:"/click-tests/all",templateUrl:INGOT_ADMIN.partials+"/click-groups.list.html",controller:"clickGroups"}).state("clickTests.edit",{url:"/click-tests/edit/:groupID",templateUrl:INGOT_ADMIN.partials+"/click-group.html",controller:"clickGroup"}).state("clickTests.new",{url:"/click-tests/new",templateUrl:INGOT_ADMIN.partials+"/click-group.html",controller:"clickGroup"}).state("clickTests.delete",{url:"/click-tests/delete/:groupID",controller:"clickDelete"}).state("clickTests.stats",{url:"/click-tests/stats/:groupID",templateUrl:INGOT_ADMIN.partials+"/click-group.stats.html",controller:"clickStats"}).state("priceTests",{url:"/price-tests",templateUrl:INGOT_ADMIN.partials+"/price-groups.html",controller:"priceGroups"}).state("settings",{url:"/settings",templateUrl:INGOT_ADMIN.partials+"/settings.html",controller:"settings"}).state("support",{url:"/support",templateUrl:INGOT_ADMIN.partials+"/support.html",controller:"support"}).state("otherwise",{url:"/",templateUrl:INGOT_ADMIN.partials+"/welcome.html",controller:"welcome"})}),ingotApp.config(["$translateProvider",function($translateProvider){$translateProvider.translations("en",INGOT_TRANSLATION).preferredLanguage("en").useSanitizeValueStrategy("escape")}]),ingotApp.controller("clickGroups",["$scope","$http","clickGroups",function($scope,$http,clickGroups){var page_limit=10;clickGroups.query({page:1,limit:page_limit,context:"admin"},function(res){if(res.data.indexOf("No matching")>-1)return void($scope.groups={});$scope.groups=JSON.parse(res.data);var total_groups=parseInt(res.headers["x-ingot-total"]);total_pages=total_groups/page_limit,$scope.total_pages=new Array(Math.round(total_pages))}),$scope.paginate=function(page,$event){jQuery(".paginate a.active").length&&jQuery(".paginate a.active").toggleClass("active"),jQuery($event.currentTarget).toggleClass("active"),page+=1,clickGroups.query({page:page,limit:page_limit,context:"admin"},function(res){res.data.indexOf("No matching groups found.")>=0||($scope.groups=JSON.parse(res.data))})}}]),ingotApp.controller("clickDelete",["$scope","$http","$stateParams","$state",function($scope,$http,$stateParams,$state){var groupID=$stateParams.groupID;"undefined"==groupID?(swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close}),$state.go("clickTests.list")):swal({title:INGOT_TRANSLATION.are_you_sure,text:INGOT_TRANSLATION.delete_confirm,type:"warning",showCancelButton:!0,confirmButtonText:INGOT_TRANSLATION["delete"],cancelButtonText:INGOT_TRANSLATION.cancel,closeOnConfirm:!1,closeOnCancel:!1},function(isConfirm){isConfirm?$http({url:INGOT_ADMIN.api+"groups/"+groupID+"?_wpnonce="+INGOT_ADMIN.nonce,method:"DELETE",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(){swal(INGOT_TRANSLATION.deleted,"","success"),$scope.group={},$state.go("clickTests.list")}).error(function(data){console.log(data),$state.go("clickTests.list"),swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})}):(swal(INGOT_TRANSLATION.canceled,"","success"),$state.go("clickTests.list"))})}]),ingotApp.controller("clickGroup",["$scope","$http","$stateParams","$rootScope","$state","clickGroups",function($scope,$http,$stateParams,$rootScope,$state,clickGroups){var is_new=!1;if($scope.group_step=1,$scope.new_group=!1,$scope.click_type_options=INGOT_ADMIN.click_type_options,"clickTests.new"==$state.current.name)is_new=!0,$scope.new_group=!0,$scope.group={type:"click",click_type_options:INGOT_ADMIN.click_type_options,variants:{},meta:{}};else{$scope.group_step=3;var groupID=$stateParams.groupID;clickGroups.get({id:groupID},function(res){function toObject(arr){for(var rv={},i=0;i<arr.length;++i)void 0!==arr[i]&&(rv[i]=arr[i]);return rv}"array"==typeof res.meta&&(res.meta=toObject(res.meta)),$scope.group=res,$scope.choose_group_type($scope.group.sub_type)},function(data,status,headers,config){console.log(data),swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})})}$scope.buttonStyle=function(id,type){var css={};return"button_color"==type?(css={},$scope.group.variants[id]&&$scope.group.variants[id].meta&&$scope.group.variants[id].meta.background_color&&(css["background-color"]=$scope.group.variants[id].meta.background_color),$scope.group.variants[id]&&$scope.group.variants[id].meta&&$scope.group.variants[id].meta.color&&(css.color=$scope.group.variants[id].meta.color),css):(css={},$scope.group.meta&&$scope.group.meta.background_color&&(css["background-color"]=$scope.group.meta.background_color),$scope.group.meta&&$scope.group.meta.color&&(css.color=$scope.group.meta.color),css)},$scope.removeTest=function(index){return $scope.group.variants.splice(index,1),!1},$scope.submit=function(data){var url;url="clickTests.new"==$state.current.name?INGOT_ADMIN.api+"groups/?context=admin":INGOT_ADMIN.api+"groups/"+groupID+"?context=admin",url+="&_wpnonce="+INGOT_ADMIN.nonce,$http({method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce},url:url,data:$scope.group}).success(function(data){$scope.group=data,!0===is_new&&(is_new=!1,$state.go("clickTests.edit",{groupID:$scope.group.ID})),swal({title:INGOT_TRANSLATION.group_saved,text:"",type:"success",confirmButtonText:INGOT_TRANSLATION.close})}).error(function(){swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})})},$scope.addNewTest=function(e){var id="ingot_"+Math.random().toString(36).substring(7);Array.isArray($scope.group.variants)||($scope.group.variants=[]),$scope.group.variants.push({ID:id})},$scope.change_step=function(step){$scope.group_step=step},$scope.partials_url=INGOT_ADMIN.partials,$scope.choose_group_type=function(type){$scope.group.sub_type=type},$scope.has_type=function(){return $scope.group?"undefined"==$scope.group.sub_type||null==$scope.group.sub_type?!1:!0:void 0}}]),ingotApp.controller("clickStats",["$scope","$http","$stateParams","$state","clickGroups",function($scope,$http,$stateParams,$state,clickGroups){console.log("starting stats..");var groupID=$stateParams.groupID;$scope.no_stats=INGOT_TRANSLATION.no_stats,$scope.group_id=groupID,"undefined"==groupID?(swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close}),$state.go("clickTests.list")):$http({url:INGOT_ADMIN.api+"groups/"+groupID+"/stats?_wpnonce="+INGOT_ADMIN.nonce+"&context=admin",method:"GET",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(res){return $scope.stats_exist=!0,Object.keys(res.variants).length?($scope.stats=res,void $http({url:INGOT_ADMIN.api+"groups/"+groupID+"?_wpnonce="+INGOT_ADMIN.nonce,method:"GET",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(res){console.log(res),$scope.chart_data={labels:[],datasets:[{label:["Conversion Rate"],fillColor:"rgba(220,220,220,0.5)",strokeColor:"rgba(220,220,220,0.8)",highlightFill:"rgba(220,220,220,0.75)",highlightStroke:"rgba(220,220,220,1)",data:[]}]},angular.forEach($scope.stats.variants,function(variant,i){var name;name="undefined"!=variant.name?variant.name:"Variant "+i,$scope.chart_data.labels.push(name);var rate=Math.round(100*variant.conversion_rate)/100;$scope.chart_data.datasets[0].data.push(rate)}),$scope.setChart($scope.stats.group.average_conversion_rate)})):void($scope.stats_exist=!1)}),Chart.types.Bar.extend({name:"BarOverlay",draw:function(ease){Chart.types.Bar.prototype.draw.apply(this);for(var ctx=this.chart.ctx,i=(this.scale.calculateBarWidth(this.datasets.length),0);i<this.options.verticalOverlayAtBar.length;++i){var overlayBar=this.options.verticalOverlayAtBar[i],y=(this.scale.calculateBarX(this.datasets.length,0,overlayBar),this.scale.calculateY(overlayBar));this.scale.endPoint;ctx.beginPath(),ctx.lineWidth=2,ctx.strokeStyle="rgba(255, 0, 0, 1.0)",ctx.moveTo(100,y),ctx.lineTo(jQuery("#ingotChart").outerWidth(),y),ctx.stroke(),ctx.font="14px Arial",ctx.fillStyle="black",ctx.fillText("Group Average Conversion Rate ("+Math.round(100*overlayBar)/100+"%)",jQuery("#ingotChart").outerWidth(),y-10)}ctx.closePath()}}),$scope.setChart=function(avg){console.log("setting chart..");var ctx=document.getElementById("ingotChart").getContext("2d");setTimeout(function(){new Chart(ctx).BarOverlay($scope.chart_data,{scaleLabel:"          <%=value%>%",responsive:!0,barValueSpacing:10,verticalOverlayAtBar:[avg]})},100)}}]),ingotApp.controller("priceGroups",["$scope","$http","priceGroups",function($scope,$http,priceGroups){var page_limit=10;priceGroups.query({page:1,limit:page_limit,context:"admin"},function(res){if($scope.total_pages=!1,$scope.groups=JSON.parse(res.data),res.headers["x-ingot-total"]){var total_groups=parseInt(res.headers["x-ingot-total"]);total_pages=total_groups/page_limit,$scope.total_pages=new Array(Math.round(total_pages))}}),$scope.paginate=function(page,$event){jQuery(".paginate a.active").length&&jQuery(".paginate a.active").toggleClass("active"),jQuery($event.currentTarget).toggleClass("active"),page+=1,priceGroups.query({page:page,limit:page_limit,context:"admin"},function(res){res.data.indexOf("No matching groups found.")>=0||($scope.groups=JSON.parse(res.data))})}}]),ingotApp.controller("priceGroup",["$scope","$http","$stateParams","$rootScope","$state","priceGroups",function($scope,$http,$stateParams,$rootScope,$state,priceGroups){if($http({url:INGOT_ADMIN.api+"products/plugins?_wpnonce="+INGOT_ADMIN.nonce,method:"GET",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(data,status,headers,config){$scope.plugins=data}).error(function(data){console.log(data)}),"priceGroup.new"==$state.current.name)$scope.group={price_type_options:INGOT_ADMIN.price_type_options};else{var groupID=$stateParams.groupID;priceGroups.get({id:groupID},function(res){"N"!=res[0]&&"o"!=res[1]&&($scope.group=res,$scope.products())},function(data,status,headers,config){console.log(data),swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})})}$scope.submit=function(){angular.forEach($scope.group.tests,function(value,key){value["default"]=parseFloat(value["default"]/100)}),priceGroups.save($scope.group,function(res){console.log(res),$scope.group=res,"priceTests.new"==$state.current.name&&$state.go("priceTests.edit").toParams({groupID:res.ID}),swal({title:INGOT_TRANSLATION.group_saved,text:"",type:"success",confirmButtonText:INGOT_TRANSLATION.close})},function(error){console.log(error),swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})})},$scope.addNewTest=function(e){var id="ingot_"+Math.random().toString(36).substring(7);$scope.group.variants||($scope.group.variants=[]),$scope.group.variants.push({ID:id,"default":0}),setTimeout(function(){jQuery(".slider-"+id).slider({value:0,min:-99,max:99,slide:function(event,ui){$scope.group.variants[jQuery(event.target).data("index")]["default"]=ui.value,jQuery(".slider-"+id+"-val").html(ui.value+"%")}}),$scope.$apply()},50)},$scope.products=function(){console.log($scope.group),"string"!=typeof $scope.group.plugin&&($scope.products={}),$http({url:INGOT_ADMIN.api+"products?plugin="+$scope.group.plugin+"&_wpnonce="+INGOT_ADMIN.nonce,method:"GET",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(data,status,headers,config){$scope.products=data}).error(function(data){console.log(data)})}}]),ingotApp.controller("support",["$scope","$http",function($scope,$http){}]),ingotApp.controller("welcome",["$scope","$http",function($scope,$http){$scope.welcome=INGOT_TRANSLATION.welcome;var url=INGOT_ADMIN.api+"settings?context=admin&_wpnonce="+INGOT_ADMIN.nonce;$http({method:"GET",url:url,headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(data,status,headers,config){$scope.welcome.settings=data}).error(function(data){console.log(data)})}]),ingotApp.controller("settings",["$scope","$http",function($scope,$http){var url=INGOT_ADMIN.api+"settings?context=admin&_wpnonce="+INGOT_ADMIN.nonce;$http({method:"GET",url:url,headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(data,status,headers,config){$scope.settings=data}).error(function(data){console.log(data)}),$scope.submit=function(){$http({method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce},url:url,data:$scope.settings}).success(function(data){$scope.settings=data,swal({title:INGOT_TRANSLATION.settings_saved,text:"",type:"success",confirmButtonText:INGOT_TRANSLATION.close})}).error(function(){swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})})}}]),ingotApp.factory("clickGroups",function($resource){return $resource(INGOT_ADMIN.api+"groups/:id",{id:"@id",_wpnonce:INGOT_ADMIN.nonce,context:"admin"},{query:{transformResponse:function(data,headers){var response={data:data,headers:headers()};return response}},update:{method:"PUT",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},post:{method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},save:{method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},"delete":{method:"DELETE",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}})}),ingotApp.factory("priceGroups",function($resource){return $resource(INGOT_ADMIN.api+"price-group/:id",{id:"@id",_wpnonce:INGOT_ADMIN.nonce,context:"admin"},{query:{transformResponse:function(data,headers){var response={data:data,headers:headers()};return response}},update:{method:"PUT",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},post:{method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},save:{method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},"delete":{method:"DELETE",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}})});