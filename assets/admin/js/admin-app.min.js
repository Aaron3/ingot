var ingotApp=angular.module("ingotApp",["ui.router","ui.bootstrap","colorpicker.module","pascalprecht.translate","ngAria","ngResource"]).run(function(a,b){a.$on("$stateChangeSuccess",function(b,c,d,e,f){"clickTests"==c.name?a.main_click_tests_page=!0:a.main_click_tests_page=!1}),a.isActiveNav=function(a){return b.current.name&&b.current.name.indexOf(a)>=0?"active":void 0}});ingotApp.config(function(a,b){b.otherwise("/"),a.state("clickTests",{url:"/click-tests",templateUrl:INGOT_ADMIN.partials+"/click-groups.html"}).state("clickTests.list",{url:"/click-tests/all",templateUrl:INGOT_ADMIN.partials+"/click-groups.list.html",controller:"clickGroups"}).state("clickTests.edit",{url:"/click-tests/edit/:groupID",templateUrl:INGOT_ADMIN.partials+"/click-group.html",controller:"clickGroup"}).state("clickTests.new",{url:"/click-tests/new",templateUrl:INGOT_ADMIN.partials+"/click-group.html",controller:"clickGroup"}).state("clickTests.delete",{url:"/click-tests/delete/:groupID",controller:"clickDelete"}).state("clickTests.stats",{url:"/click-tests/stats/:groupID",templateUrl:INGOT_ADMIN.partials+"/click-group.stats.html",controller:"clickStats"}).state("priceTests",{url:"/price-tests",templateUrl:INGOT_ADMIN.partials+"/price-groups.html",controller:"priceGroups"}).state("settings",{url:"/settings",templateUrl:INGOT_ADMIN.partials+"/settings.html",controller:"settings"}).state("support",{url:"/support",templateUrl:INGOT_ADMIN.partials+"/support.html",controller:"support"}).state("otherwise",{url:"/",templateUrl:INGOT_ADMIN.partials+"/welcome.html",controller:"welcome"})}),ingotApp.config(["$translateProvider",function(a){a.translations("en",INGOT_TRANSLATION).preferredLanguage("en").useSanitizeValueStrategy("escape")}]),ingotApp.controller("clickGroups",["$scope","$http","clickGroups",function(a,b,c){var d=10;c.query({page:1,limit:d,context:"admin"},function(b){if(b.data.indexOf("No matching")>-1)return void(a.groups={});a.groups=JSON.parse(b.data);var c=parseInt(b.headers["x-ingot-total"]);total_pages=c/d,a.total_pages=new Array(Math.round(total_pages))}),a.paginate=function(b,e){jQuery(".paginate a.active").length&&jQuery(".paginate a.active").toggleClass("active"),jQuery(e.currentTarget).toggleClass("active"),b+=1,c.query({page:b,limit:d,context:"admin"},function(b){b.data.indexOf("No matching groups found.")>=0||(a.groups=JSON.parse(b.data))})}}]),ingotApp.controller("clickDelete",["$scope","$http","$stateParams","$state",function(a,b,c,d){var e=c.groupID;"undefined"==e?(swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close}),d.go("clickTests.list")):swal({title:INGOT_TRANSLATION.are_you_sure,text:INGOT_TRANSLATION.delete_confirm,type:"warning",showCancelButton:!0,confirmButtonText:INGOT_TRANSLATION["delete"],cancelButtonText:INGOT_TRANSLATION.cancel,closeOnConfirm:!1,closeOnCancel:!1},function(c){c?b({url:INGOT_ADMIN.api+"groups/"+e+"?_wpnonce="+INGOT_ADMIN.nonce,method:"DELETE",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(){swal(INGOT_TRANSLATION.deleted,"","success"),a.group={},d.go("clickTests.list")}).error(function(a){console.log(a),d.go("clickTests.list"),swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})}):(swal(INGOT_TRANSLATION.canceled,"","success"),d.go("clickTests.list"))})}]),ingotApp.controller("clickGroup",["$scope","$http","$stateParams","$rootScope","$state","clickGroups",function(a,b,c,d,e,f){var g=!1;if(a.group_step=1,a.new_group=!1,a.click_type_options=INGOT_ADMIN.click_type_options,"clickTests.new"==e.current.name)g=!0,a.new_group=!0,a.group={type:"click",click_type_options:INGOT_ADMIN.click_type_options,variants:{},meta:{}};else{a.group_step=3;var h=c.groupID;f.get({id:h},function(b){function c(a){for(var b={},c=0;c<a.length;++c)void 0!==a[c]&&(b[c]=a[c]);return b}"array"==typeof b.meta&&(b.meta=c(b.meta)),a.group=b,a.choose_group_type(a.group.sub_type)},function(a,b,c,d){console.log(a),swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})})}a.buttonStyle=function(b,c){var d={};return"button_color"==c?(d={},a.group.variants[b]&&a.group.variants[b].meta&&a.group.variants[b].meta.background_color&&(d["background-color"]=a.group.variants[b].meta.background_color),a.group.variants[b]&&a.group.variants[b].meta&&a.group.variants[b].meta.color&&(d.color=a.group.variants[b].meta.color),d):(d={},a.group.meta&&a.group.meta.background_color&&(d["background-color"]=a.group.meta.background_color),a.group.meta&&a.group.meta.color&&(d.color=a.group.meta.color),d)},a.removeTest=function(b){return a.group.variants.splice(b,1),!1},a.submit=function(c){var d;d="clickTests.new"==e.current.name?INGOT_ADMIN.api+"groups/?context=admin":INGOT_ADMIN.api+"groups/"+h+"?context=admin",d+="&_wpnonce="+INGOT_ADMIN.nonce,b({method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce},url:d,data:a.group}).success(function(b){a.group=b,!0===g&&(g=!1,e.go("clickTests.edit",{groupID:a.group.ID})),swal({title:INGOT_TRANSLATION.group_saved,text:"",type:"success",confirmButtonText:INGOT_TRANSLATION.close})}).error(function(){swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})})},a.addNewTest=function(b){var c="ingot_"+Math.random().toString(36).substring(7);Array.isArray(a.group.variants)||(a.group.variants=[]),a.group.variants.push({ID:c})},a.change_step=function(b){a.group_step=b},a.partials_url=INGOT_ADMIN.partials,a.choose_group_type=function(b){a.group.sub_type=b},a.has_type=function(){return a.group?"undefined"==a.group.sub_type||null==a.group.sub_type?!1:!0:void 0}}]),ingotApp.controller("clickStats",["$scope","$http","$stateParams","$state","clickGroups",function(a,b,c,d,e){console.log("starting stats..");var f=c.groupID;a.no_stats=INGOT_TRANSLATION.no_stats,a.group_id=f,"undefined"==f?(swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close}),d.go("clickTests.list")):b({url:INGOT_ADMIN.api+"groups/"+f+"/stats?_wpnonce="+INGOT_ADMIN.nonce+"&context=admin",method:"GET",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(b){return a.stats_exist=!0,Object.keys(b.variants).length?(a.stats=b,a.chart_data={labels:[],datasets:[{label:["Conversion Rate"],fillColor:"rgba(220,220,220,0.5)",strokeColor:"rgba(220,220,220,0.8)",highlightFill:"rgba(220,220,220,0.75)",highlightStroke:"rgba(220,220,220,1)",data:[]}]},angular.forEach(a.stats.variants,function(b,c){var d;d="undefined"!==b.name?b.name:"Variant "+c,a.chart_data.labels.push(d);var e=Math.round(100*b.conversion_rate)/100;a.chart_data.datasets[0].data.push(e)}),void a.setChart(a.stats.group.average_conversion_rate)):void(a.stats_exist=!1)}),Chart.types.Bar.extend({name:"BarOverlay",draw:function(a){Chart.types.Bar.prototype.draw.apply(this);for(var b=this.chart.ctx,c=(this.scale.calculateBarWidth(this.datasets.length),0);c<this.options.verticalOverlayAtBar.length;++c){var d=this.options.verticalOverlayAtBar[c],e=(this.scale.calculateBarX(this.datasets.length,0,d),this.scale.calculateY(d));this.scale.endPoint;b.beginPath(),b.lineWidth=2,b.strokeStyle="rgba(255, 0, 0, 1.0)",b.moveTo(100,e),b.lineTo(jQuery("#ingotChart").outerWidth(),e),b.stroke(),b.font="14px Arial",b.fillStyle="black",b.fillText("Group Average Conversion Rate ("+Math.round(100*d)/100+"%)",jQuery("#ingotChart").outerWidth(),e-10)}b.closePath()}}),a.setChart=function(b){console.log("setting chart..");var c=document.getElementById("ingotChart").getContext("2d");setTimeout(function(){new Chart(c).BarOverlay(a.chart_data,{scaleLabel:"          <%=value%>%",responsive:!0,barValueSpacing:10,verticalOverlayAtBar:[b]})},100)}}]),ingotApp.controller("priceGroups",["$scope","$http","priceGroups",function(a,b,c){var d=10;c.query({page:1,limit:d,context:"admin"},function(b){if(a.total_pages=!1,a.groups=JSON.parse(b.data),b.headers["x-ingot-total"]){var c=parseInt(b.headers["x-ingot-total"]);total_pages=c/d,a.total_pages=new Array(Math.round(total_pages))}}),a.paginate=function(b,e){jQuery(".paginate a.active").length&&jQuery(".paginate a.active").toggleClass("active"),jQuery(e.currentTarget).toggleClass("active"),b+=1,c.query({page:b,limit:d,context:"admin"},function(b){b.data.indexOf("No matching groups found.")>=0||(a.groups=JSON.parse(b.data))})}}]),ingotApp.controller("priceGroup",["$scope","$http","$stateParams","$rootScope","$state","priceGroups",function(a,b,c,d,e,f){if(b({url:INGOT_ADMIN.api+"products/plugins?_wpnonce="+INGOT_ADMIN.nonce,method:"GET",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(b,c,d,e){a.plugins=b}).error(function(a){console.log(a)}),"priceGroup.new"==e.current.name)a.group={price_type_options:INGOT_ADMIN.price_type_options};else{var g=c.groupID;f.get({id:g},function(b){"N"!=b[0]&&"o"!=b[1]&&(a.group=b,a.products())},function(a,b,c,d){console.log(a),swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})})}a.submit=function(){angular.forEach(a.group.tests,function(a,b){a["default"]=parseFloat(a["default"]/100)}),f.save(a.group,function(b){console.log(b),a.group=b,"priceTests.new"==e.current.name&&e.go("priceTests.edit").toParams({groupID:b.ID}),swal({title:INGOT_TRANSLATION.group_saved,text:"",type:"success",confirmButtonText:INGOT_TRANSLATION.close})},function(a){console.log(a),swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})})},a.addNewTest=function(b){var c="ingot_"+Math.random().toString(36).substring(7);a.group.variants||(a.group.variants=[]),a.group.variants.push({ID:c,"default":0}),setTimeout(function(){jQuery(".slider-"+c).slider({value:0,min:-99,max:99,slide:function(b,d){a.group.variants[jQuery(b.target).data("index")]["default"]=d.value,jQuery(".slider-"+c+"-val").html(d.value+"%")}}),a.$apply()},50)},a.products=function(){console.log(a.group),"string"!=typeof a.group.plugin&&(a.products={}),b({url:INGOT_ADMIN.api+"products?plugin="+a.group.plugin+"&_wpnonce="+INGOT_ADMIN.nonce,method:"GET",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(b,c,d,e){a.products=b}).error(function(a){console.log(a)})}}]),ingotApp.controller("support",["$scope","$http",function(a,b){}]),ingotApp.controller("welcome",["$scope","$http",function(a,b){a.welcome=INGOT_TRANSLATION.welcome;var c=INGOT_ADMIN.api+"settings?context=admin&_wpnonce="+INGOT_ADMIN.nonce;b({method:"GET",url:c,headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(b,c,d,e){a.welcome.settings=b}).error(function(a){console.log(a)})}]),ingotApp.controller("settings",["$scope","$http",function(a,b){var c=INGOT_ADMIN.api+"settings?context=admin&_wpnonce="+INGOT_ADMIN.nonce;b({method:"GET",url:c,headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}).success(function(b,c,d,e){a.settings=b}).error(function(a){console.log(a)}),a.submit=function(){b({method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce},url:c,data:a.settings}).success(function(b){a.settings=b,swal({title:INGOT_TRANSLATION.settings_saved,text:"",type:"success",confirmButtonText:INGOT_TRANSLATION.close})}).error(function(){swal({title:INGOT_TRANSLATION.fail,text:INGOT_TRANSLATION.sorry,type:"error",confirmButtonText:INGOT_TRANSLATION.close})})}}]),ingotApp.factory("clickGroups",function(a){return a(INGOT_ADMIN.api+"groups/:id",{id:"@id",_wpnonce:INGOT_ADMIN.nonce,context:"admin"},{query:{transformResponse:function(a,b){var c={data:a,headers:b()};return c}},update:{method:"PUT",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},post:{method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},save:{method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},"delete":{method:"DELETE",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}})}),ingotApp.factory("priceGroups",function(a){return a(INGOT_ADMIN.api+"price-group/:id",{id:"@id",_wpnonce:INGOT_ADMIN.nonce,context:"admin"},{query:{transformResponse:function(a,b){var c={data:a,headers:b()};return c}},update:{method:"PUT",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},post:{method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},save:{method:"POST",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}},"delete":{method:"DELETE",headers:{"X-WP-Nonce":INGOT_ADMIN.nonce}}})});